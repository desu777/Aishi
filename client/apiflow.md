# API Flow Documentation

## server/

This section documents the API endpoints and data structures for the `server/` part of the application.

**Base Path Assumption:** For API groups like `users`, `ratings`, `comments`, and `gravity-score`, the base path (e.g., `/api/users`, `/api/ratings`) is assumed based on common RESTful practices and the router file names.

### `/api/pools`
*   Managed by: `server/src/routes/pools.js`
*   **`GET /`**: Get all pools.
    *   Response: List of pools.
*   **`GET /trending`**: Get trending pools.
    *   Response: List of trending pools.
*   **`GET /top-gravity`**: Get top pools ranked by Gravity Score.
    *   Response: List of top pools by gravity score.
*   **`GET /search?q=<query>`**: Search pools by name, symbol, or address.
    *   Query Params: `q` (string) - The search term.
    *   Response: List of matching pools.
*   **`GET /creator/:address`**: Get all pools created by a specific wallet address.
    *   Path Params: `address` (string) - Creator's wallet address.
    *   Response: List of pools by the creator.
*   **`GET /admin/initialize-price-history`**: Admin endpoint to initialize price history data for all pools. (Protected: Requires admin privileges - not explicitly implemented in route, but implied by name).
    *   Response: Success/error message.
*   **`GET /admin/update-holders?poolId=<poolId>`**: Admin endpoint to update holder data for all pools or a specific pool. (Protected: Requires admin privileges - not explicitly implemented in route, but implied by name).
    *   Query Params: `poolId` (integer, optional) - ID of the specific pool to update. If omitted, all pools are updated.
    *   Response: Result of the update (e.g., number of pools updated, success/error status).
*   **`GET /admin/update-bonding-curve-percentages`**: Admin endpoint to update bonding curve percentages for all pools. (Protected: Requires admin privileges - not explicitly implemented in route, but implied by name).
    *   Response: Result of the update.
*   **`POST /`**: Create a new pool.
    *   Request Body: Multipart/form-data including pool data and an optional `image` file for the pool logo.
        *   `image`: (File) Logo for the pool (JPEG, PNG, GIF, WebP, max 500KB). Image is processed (resized to max 256x256).
        *   Other pool data fields (e.g., `name`, `symbol`, `creatorAddress`, etc. - defined in `poolController.createPool`).
    *   Response: Created pool object or error message.
*   **`GET /:address/price-history`**: Get historical price data for a specific pool.
    *   Path Params: `address` (string) - Pool contract address.
    *   Response: Price history data (array of price points).
*   **`GET /:address/holders`**: Get holder distribution data for a specific pool.
    *   Path Params: `address` (string) - Pool contract address.
    *   Response: Holder distribution data.
*   **`GET /:address/holders/list`**: Get a detailed list of all holders for a specific pool.
    *   Path Params: `address` (string) - Pool contract address.
    *   Response: List of holder objects.
*   **`GET /:address`**: Get detailed information about a specific pool by its contract address.
    *   Path Params: `address` (string) - Pool contract address.
    *   Response: Detailed pool object.
*   **`POST /:address/graduate`**: Graduate a token from a bonding curve to a liquidity pool. (Protected: Intended for creator only, though current validation might be permissive).
    *   Path Params: `address` (string) - Token contract address.
    *   Response: Status of the graduation process.

### `/api/transactions`
*   Managed by: `server/src/routes/transactions.js`
*   **`GET /latest`**: Get the latest transaction recorded in the system.
    *   Response: The latest transaction object.
*   **`GET /pool/:address`**: Get transactions for a specific pool.
    *   Path Params: `address` (string) - Pool contract address.
    *   Response: List of transactions associated with the pool.
*   **`POST /`**: Record a new transaction.
    *   Request Body: Transaction data (details to be inferred from `transactionsController.recordTransaction`).
    *   Response: Recorded transaction object or error message.

### `/api/ratings`
*   Managed by: `server/src/routes/ratings.js`
*   **`POST /`**: Add or update a rating for a pool by a user.
    *   Request Body: Rating data, including `poolId`, `walletAddress` (the address performing the rating), `ratingValue` (e.g., 1-5), and a `signature` generated by the user's wallet to authorize the action. The server will verify this signature against the provided `walletAddress` and the rating data.
    *   Response: Status of the rating submission (e.g., success message, updated rating object).
*   **`GET /user/:poolId/:walletAddress`**: Get a user's specific rating for a given pool.
    *   Path Params:
        *   `poolId` (integer or string) - Identifier of the pool.
        *   `walletAddress` (string) - Wallet address of the user.
    *   Response: The user's rating for the pool.
*   **`GET /average/:poolId`**: Get the average rating for a specific pool.
    *   Path Params: `poolId` (integer or string) - Identifier of the pool.
    *   Response: Average rating value for the pool.
*   **`GET /distribution/:poolId`**: Get the distribution of ratings for a specific pool (e.g., how many 5-star, 4-star, etc.).
    *   Path Params: `poolId` (integer or string) - Identifier of the pool.
    *   Response: Rating distribution data.

### `/api/users`
*   Managed by: `server/src/routes/users.js`
*   **`POST /register`**: Register a new user.
    *   Request Body: User registration details (e.g., `walletAddress`, `password`, `username`). Details from `UserController.register`.
    *   Response: Newly created user object (possibly excluding sensitive info like password) or error message.
*   **`POST /login`**: Log in an existing user.
    *   Request Body: User login credentials (e.g., `walletAddress` or `username`, `password`). Details from `UserController.login`.
    *   Response: Authentication token, user object (excluding sensitive info), or error message.
*   **`POST /reauth`**: Re-authenticate a user, possibly to refresh an authentication token.
    *   Request Body: Likely requires an existing valid (or refresh) token, or specific re-authentication credentials. Details from `UserController.reauth`.
    *   Response: New authentication token or error message.
*   **`GET /check/:address`**: Check if a wallet address is already registered or associated with a user.
    *   Path Params: `address` (string) - Wallet address to check.
    *   Response: Boolean indicating if the wallet exists/is registered, or user details if found.

### `/api/comments`
*   Managed by: `server/src/routes/comments.js`
*   **`GET /pool/:address`**: Get comments for a specific pool.
    *   Path Params: `address` (string) - Pool contract address.
    *   Response: List of comments associated with the pool.
*   **`POST /pool/:address`**: Create a new comment for a specific pool.
    *   Path Params: `address` (string) - Pool contract address.
    *   Request Body: Comment data including `text` of the comment, `walletAddress` (the address of the commenter), and a `signature` generated by the user's wallet to authorize the comment creation. The server will verify this signature against the provided `walletAddress` and the comment data. Details from `commentController.createComment`.
    *   Response: Created comment object or error message.
*   **`POST /like/:id`**: Like or unlike a specific comment.
    *   Path Params: `id` (integer or string) - Identifier of the comment to be liked/unliked.
    *   Request Body: Includes `walletAddress` (the address of the user performing the action) and a `signature` generated by the user's wallet to authorize the like/unlike action. The server will verify this signature against the provided `walletAddress`.
    *   Response: Updated like count for the comment or status message.

### `/api/gravity-score`
*   Managed by: `server/src/routes/gravityScore.js`
*   **`GET /pool/:poolId`**: Get the latest gravity score details for a specific pool.
    *   Path Params: `poolId` (integer) - Identifier of the pool.
    *   Response: Object containing gravity score details (e.g., `score`, `factors`, `last_updated`).
*   **`GET /pool/:poolId/history?limit=<limit>`**: Get the historical gravity scores for a specific pool.
    *   Path Params: `poolId` (integer) - Identifier of the pool.
    *   Query Params: `limit` (integer, optional, default: 30) - Maximum number of historical records to return.
    *   Response: Array of historical gravity score records.
*   **`GET /top?limit=<limit>`**: Get pools with the highest gravity scores.
    *   Query Params: `limit` (integer, optional, default: 10) - Number of top-scoring pools to return.
    *   Response: List of pool objects, sorted by gravity score in descending order.
*   **`POST /recalculate/:poolId`**: Force recalculation of the gravity score for a specific pool. (Admin Access Required)
    *   Path Params: `poolId` (integer) - Identifier of the pool.
    *   Requires Auth: `verifyToken` (checks for admin role, though simplified in current code).
    *   Response: Success message and the newly recalculated gravity score.
*   **`POST /update-all`**: Trigger an update (recalculation) of gravity scores for all relevant pools. (Admin Access Required)
    *   Requires Auth: `verifyToken` (checks for admin role, though simplified in current code).
    *   Response: Message indicating that the gravity score update process has been initiated (likely runs as a background job).

---

## lf0gfactory/

This section documents the API endpoints for the `lf0gfactory/` service, which appears to handle token creation and related operations on a blockchain.

*   Managed by: `lf0gfactory/server.js`
*   The server listens on `PORT` (environment variable) or defaults to `5005`.

### `POST /create-token`
*   **Description**: Creates a new token using the TokenFactory contract.
*   **Request Body**:
    *   `name` (string, required): The name of the token.
    *   `symbol` (string, required): The symbol of the token.
    *   `description` (string, optional): A description for the token.
    *   `creatorAddress` (string, required): The wallet address of the token's intended creator. This address is stored in a separate mapping (`real-creators.json`) as the on-chain creator might be the server's wallet.
*   **Response (Success 200)**:
    ```json
    {
      "success": true,
      "data": {
        "txHash": "string", // Transaction hash of the token creation
        "tokenAddress": "string", // Address of the newly created token contract
        "name": "string",
        "symbol": "string",
        "description": "string",
        "creatorAddress": "string" // The intended creator address passed in the request
      }
    }
    ```
*   **Response (Error 400/500)**:
    ```json
    {
      "success": false,
      "error": "string" // Error message
    }
    ```

### `GET /factory-info`
*   **Description**: Retrieves information about the deployed TokenFactory contract and the network.
*   **Response (Success 200)**:
    ```json
    {
      "success": true,
      "data": {
        "factoryAddress": "string", // Address of the TokenFactory contract
        "totalTokensCreated": "number", // Total number of tokens created by this factory
        "network": {
          "name": "string", // e.g., "0G-Galileo-Testnet"
          "chainId": "number", // e.g., 16601
          "rpcUrl": "string" // RPC URL used by the factory server
        }
      }
    }
    ```
*   **Response (Error 500)**:
    ```json
    {
      "success": false,
      "error": "string" // Error message
    }
    ```

### `POST /api/claim-tokens`
*   **Description**: Allows a user, identified as the creator (or owner) of a token, to claim unlocked tokens. The process involves the server's wallet first claiming the tokens from the `BondingCurveToken` contract and then transferring them to the `userAddress` specified in the request. The server maintains a mapping of `tokenAddress` to `realCreatorAddress` in `real-creators.json` to authorize this.
*   **Request Body**:
    *   `tokenAddress` (string, required): The contract address of the `BondingCurveToken`.
    *   `userAddress` (string, required): The wallet address of the user who should receive the claimed tokens (expected to be the creator).
*   **Response (Success 200)**:
    ```json
    {
      "success": true,
      "claimTxHash": "string", // Transaction hash of the server claiming tokens
      "transferTxHash": "string", // Transaction hash of the server transferring tokens to userAddress
      "amount": "string" // The amount of tokens claimed and transferred, formatted as a string (e.g., "100.0")
    }
    ```
*   **Response (Error 400/500)**:
    ```json
    {
      "success": false,
      "error": "string" // Error message (e.g., "Missing required parameters", "Invalid Ethereum address", "No tokens to claim", or other transaction errors)
    }
    ```

---

## transaction-broadcast-service/

This section documents the API endpoints and Socket.IO events for the `transaction-broadcast-service/`, which is responsible for real-time broadcasting of transaction, pool, and price update data.

*   Managed by: `transaction-broadcast-service/server.js`
*   The server listens on `PORT` (environment variable) or defaults to `3005`.
*   It uses Express for HTTP endpoints and Socket.IO for real-time communication.

### HTTP API Endpoints

**`POST /api/pool-data-update`**
*   **Description**: Receives a full or partial data snapshot for a specific pool, merges it with any existing data for that pool, and broadcasts the updated snapshot to clients subscribed to that pool's room via Socket.IO.
*   **Request Body**:
    *   `poolAddress` (string, required): The address of the pool being updated.
    *   `...payload` (object, required): An object containing the pool data fields to be updated or added (e.g., price, volume, liquidity, list of recent transactions for the pool page).
*   **Response (Success 200)**:
    ```json
    { "success": true }
    ```
*   **Response (Error 400)**:
    ```json
    { "success": false, "error": "poolAddress required" }
    ```
*   **Socket.IO Side-effect**: Emits a `pool_data_update` event to the room `pool_${poolAddress}` with the data `{ poolAddress, ...mergedData }`.
    *   Note: If `mergedData.transactions` exists and its length exceeds 20, it's trimmed to the latest 20 transactions.

**`POST /api/pool-transaction-update`**
*   **Description**: Receives a single new transaction for a specific pool, prepends it to the pool's existing list of transactions (maintaining a max of 20, deduping by `tx_hash`), and broadcasts this single transaction to clients subscribed to that pool's room.
*   **Request Body**:
    *   `poolAddress` (string, required): The address of the pool the transaction belongs to.
    *   `transaction` (object, required): The new transaction object.
*   **Response (Success 200)**:
    ```json
    { "success": true }
    ```
*   **Response (Error 400)**:
    ```json
    { "success": false, "error": "poolAddress and transaction required" }
    ```
*   **Socket.IO Side-effect**: Emits a `pool_transaction_update` event to the room `pool_${poolAddress}` with the data `{ poolAddress, transaction }`.

**`POST /api/broadcast-transaction`**
*   **Description**: Receives a transaction object and broadcasts it to all connected Socket.IO clients via the `new_transaction` event. The transaction is also added to an in-memory list of recent transactions (max 10).
*   **Request Body**: `transaction` (object) - The transaction object itself.
*   **Response (Success 200)**:
    ```json
    { "success": true }
    ```
*   **Socket.IO Side-effect**: Emits a `new_transaction` event to all clients with the `transaction` object.

**`POST /api/broadcast-pool`**
*   **Description**: Receives a new pool's data object and broadcasts it to all connected Socket.IO clients via the `new_pool` event. The pool data is also added to an in-memory list of recent pools (max 10).
*   **Request Body**: `pool` (object) - The data object for the new pool.
*   **Response (Success 200)**:
    ```json
    { "success": true }
    ```
*   **Socket.IO Side-effect**: Emits a `new_pool` event to all clients with the `pool` object.

**`POST /api/update-price-change`**
*   **Description**: Receives price change data (e.g., 24-hour percentage change) for a pool and broadcasts it to all connected Socket.IO clients via the `price_change_update` event.
*   **Request Body**: `priceChangeData` (object) - Data related to price changes, likely including `poolId` and change metrics.
*   **Response (Success 200)**:
    ```json
    { "success": true }
    ```
*   **Socket.IO Side-effect**: Emits a `price_change_update` event to all clients with `priceChangeData`.

**`GET /health`**
*   **Description**: A health check endpoint providing basic status information about the service.
*   **Response (Success 200)**:
    ```json
    {
      "status": "ok",
      "clients": "number", // Current number of connected Socket.IO clients
      "recentTransactions": "number", // Number of transactions in the recent history cache
      "recentPools": "number", // Number of pools in the recent history cache
      "mode": "string" // "test" or "production"
    }
    ```

### Socket.IO Events

**Server Emits / Client Listens:**

*   **`pool_data_update`** (to room `pool_${poolAddress}`)
    *   **Trigger**: After a `POST /api/pool-data-update` or when a client successfully `subscribe_pool` and data exists for that pool.
    *   **Data**: `{ poolAddress: string, ...mergedPoolData: object }` - The complete, merged data snapshot for the subscribed pool.
*   **`pool_transaction_update`** (to room `pool_${poolAddress}`)
    *   **Trigger**: After a `POST /api/pool-transaction-update`.
    *   **Data**: `{ poolAddress: string, transaction: object }` - The single new transaction for the subscribed pool.
*   **`new_transaction`** (to all clients)
    *   **Trigger**: After a `POST /api/broadcast-transaction` or when any client emits `broadcast_transaction`.
    *   **Data**: `transaction: object` - The globally broadcast transaction.
*   **`new_pool`** (to all clients)
    *   **Trigger**: After a `POST /api/broadcast-pool` or when any client emits `broadcast_pool`.
    *   **Data**: `pool: object` - The globally broadcast new pool data.
*   **`price_change_update`** (to all clients)
    *   **Trigger**: After a `POST /api/update-price-change` or when any client emits `broadcast_price_change`.
    *   **Data**: `priceChangeData: object` - The globally broadcast price change information.
*   **`recent_transactions`** (to a newly connected client)
    *   **Trigger**: Upon a new client connection, if recent transactions history is not empty.
    *   **Data**: `Array<transaction: object>` - List of recently broadcast transactions (up to 10).
*   **`recent_pools`** (to a newly connected client)
    *   **Trigger**: Upon a new client connection, if recent pools history is not empty.
    *   **Data**: `Array<pool: object>` - List of recently broadcast new pools (up to 10).

**Client Emits / Server Listens:**

*   **`broadcast_transaction`**
    *   **Description**: Client requests the server to broadcast a transaction to all other clients.
    *   **Data**: `transaction: object`
    *   **Server Action**: Adds to recent history, then emits `new_transaction` to all clients (including the sender).
*   **`broadcast_pool`**
    *   **Description**: Client requests the server to broadcast new pool data to all other clients.
    *   **Data**: `pool: object`
    *   **Server Action**: Adds to recent history, then emits `new_pool` to all clients (including the sender).
*   **`broadcast_price_change`**
    *   **Description**: Client requests the server to broadcast price change data.
    *   **Data**: `priceChangeData: object`
    *   **Server Action**: Emits `price_change_update` to all clients (including the sender).
*   **`subscribe_pool`**
    *   **Description**: Client subscribes to receive targeted `pool_data_update` and `pool_transaction_update` events for a specific pool.
    *   **Data**: `address: string` (the pool address to subscribe to).
    *   **Server Action**: Joins the client's socket to a room named `pool_${address}`. If data for this pool exists in `poolDataMap`, immediately emits `pool_data_update` to the subscribing client.
*   **`unsubscribe_pool`**
    *   **Description**: Client unsubscribes from targeted updates for a specific pool.
    *   **Data**: `address: string` (the pool address to unsubscribe from).
    *   **Server Action**: Removes the client's socket from the room `pool_${address}`.

---
